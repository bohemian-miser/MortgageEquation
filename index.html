<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mortgage Equation</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Global Objects) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (Compiles JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom styles */
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        
        /* Hide scrollbar for compact stats */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animation */
        @keyframes shake-needle {
          0% { transform: rotate(0deg); } 
          25% { transform: rotate(5deg); } 
          50% { transform: rotate(-5deg); } 
          75% { transform: rotate(3deg); } 
          100% { transform: rotate(0deg); }
        }
        .needle-shake { animation: shake-needle 0.15s infinite linear; transform-origin: 0 0; }

        /* --- CROSS BROWSER SLIDER RESET --- */
        /* This ensures the invisible input actually works on iOS/Firefox by stripping default styling */
        .range-input {
            -webkit-appearance: none; /* Hides the slider so that custom slider can be made */
            appearance: none;
            width: 100%; /* Specific width is required for Firefox. */
            background: transparent; /* Otherwise white in Chrome */
            cursor: pointer;
            touch-action: none; /* Prevents scroll when dragging on mobile */
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
            margin-top: -8px; 
        }

        .range-input::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border: none;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
        }

        .range-input:focus {
            outline: none;
        }
    </style>
</head>
<body>
    <!-- Find me on github octocat in the corner  -->
    <a href="https://github.com/bohemian-miser/MortgageEquation" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- MARKET DATA STRUCTURE ---

    const MARKET_DATA = {
            "Global": {
                "investmentReturn": [2.0, 5.0, 8.0, 11.0],
                "mortgageRate": [2.0, 4.0, 7, 10],
                "propertyTypes": {
                    "house": {
                        "appreciation": [-5.0, 1.5, 5.0, 8.2],
                        "feesRate": [0.7, 1.6, 2.6, 4.0]
                    },
                    "apartment": {
                        "appreciation": [-7.0, 1.5, 3.75, 6.75],
                        "feesRate": [0.9, 2.0, 3.5, 5.0]
                    }
                }
            },
            "Australia": {
                "investmentReturn": [2.5, 5.5, 8.8, 12.0],
                "mortgageRate": [3.0, 4.0, 7.2, 8.75],
                "propertyTypes": {
                    "house": {
                        "appreciation": [-1.0, 3.0, 6.5, 8.5],
                        "feesRate": [0.6, 1.0, 1.6, 2.8]
                    },
                    "apartment": {
                        "appreciation": [-6.0, 2.5, 5.5, 7.5],
                        "feesRate": [0.9, 1.5, 2.3, 3.5]
                    }
                }
            },
            "United States": {
                "investmentReturn": [3.0, 7.5, 11.8, 14.0],
                "mortgageRate": [3.0, 5.0, 6.75, 8.5],
                "propertyTypes": {
                    "house": {
                        "appreciation": [-2.0, 2.0, 4.5, 7.0],
                        "feesRate": [1.2, 2.0, 3.0, 4.8]
                    },
                    "apartment": {
                        "appreciation": [-6.0, 1.0, 4.0, 6.0],
                        "feesRate": [1.8, 2.8, 4.0, 5.5]
                    }
                }
            },
            "United Kingdom": {
                "investmentReturn": [2.0, 5.0, 7.8, 10.5],
                "mortgageRate": [2.5, 3.8, 7.0, 10.5],
                "propertyTypes": {
                    "house": {
                        "appreciation": [-1.0, 1.5, 3.5, 7.0],
                        "feesRate": [1.0, 1.5, 2.2, 3.2]
                    },
                    "apartment": {
                        "appreciation": [-6.0, 0.5, 3.5, 5.75],
                        "feesRate": [1.3, 2.0, 3.0, 4.2]
                    }
                }
            }
        };

        const DEFAULT_INPUTS = {
            homeValue: 1000000,
            downPaymentPercent: 20,
            mortgageRate: 5.4,
            stockReturn: 7.5,
            appreciation: 4.0,
            feesRate: 2.2,
            monthlyRent: 2500,
        };

        // --- URL STATE MANAGEMENT (XSS SAFE) ---
        
        // 1. Safe parsing (Read)
        const getParamsFromURL = () => {
            const params = new URLSearchParams(window.location.search);
            
            // Helper to safely parse float or return default
            const getFloat = (key, def) => {
                const val = parseFloat(params.get(key));
                return isNaN(val) ? def : val;
            };

            // Helper to strictly validate strings against whitelist
            const getString = (key, validOptions, def) => {
                const val = params.get(key);
                return (val && validOptions.includes(val)) ? val : def;
            };

            const safeLocation = getString('location', Object.keys(MARKET_DATA), "Global");
            const safeType = getString('type', ['house', 'apartment'], "house");
            const inputs = {
                homeValue: getFloat('homeValue', DEFAULT_INPUTS.homeValue),
                downPaymentPercent: getFloat('downPaymentPercent', DEFAULT_INPUTS.downPaymentPercent),
                mortgageRate: getFloat('mortgageRate', DEFAULT_INPUTS.mortgageRate),
                stockReturn: getFloat('stockReturn', DEFAULT_INPUTS.stockReturn),
                appreciation: getFloat('appreciation', DEFAULT_INPUTS.appreciation),
                feesRate: getFloat('feesRate', DEFAULT_INPUTS.feesRate),
                monthlyRent: getFloat('monthlyRent', DEFAULT_INPUTS.monthlyRent),
            };
            
            return { location: safeLocation, propertyType: safeType, inputs };
        };
        const CurrencyInput = ({ value, name, onChange, className }) => {
        // We use a ref to access the actual DOM input element
        const inputRef = React.useRef(null);
        const [cursor, setCursor] = useState(null);

        // Format helper
        const format = (val) => new Intl.NumberFormat('en-US').format(val);

        // Run this layout effect immediately after every render to restore cursor
        React.useLayoutEffect(() => {
            if (inputRef.current && cursor !== null) {
                // Restore the cursor position we calculated
                inputRef.current.setSelectionRange(cursor, cursor);
            }
        }, [cursor, value]);

        const handleChange = (e) => {
            const rawValue = e.target.value;
            const oldCursorPos = e.target.selectionStart;
            
            // 1. Calculate how many distinct digits were to the left of the cursor *before* formatting
            //    (We ignore commas because they move around)
            const digitsBeforeCursor = rawValue.slice(0, oldCursorPos).replace(/[^0-9]/g, '').length;
            
            // 2. Process the number
            const cleanValue = rawValue.replace(/[^0-9]/g, '');
            const numValue = cleanValue === '' ? 0 : parseInt(cleanValue, 10);
            const formattedValue = format(numValue);
            
            // 3. Find the new cursor position in the NEW formatted string
            //    We scan the new string and stop when we've passed the same number of digits
            let newCursorPos = 0;
            let digitsEncountered = 0;
            
            for (let i = 0; i < formattedValue.length; i++) {
                if (/[0-9]/.test(formattedValue[i])) {
                    digitsEncountered++;
                }
                // If we haven't reached our target digit count, or if the current char is a comma, advance cursor
                if (digitsEncountered <= digitsBeforeCursor) {
                    newCursorPos = i + 1;
                } else {
                    break;
                }
            }

            // 4. Update State (Triggering the Effect above)
            setCursor(newCursorPos);
            
            // 5. Send data back to parent
            //    We create a fake event object so your existing handler still works
            onChange({
                target: {
                    name: name,
                    value: numValue,
                    type: 'text' // Force type text logic
                }
            });
        };

        return (
            <input
                ref={inputRef}
                type="text"
                name={name}
                value={value === 0 ? '' : format(value)}
                onChange={handleChange}
                className={className}
                placeholder="0"
            />
        );
    };
        const RentVsBuySeesaw = () => {
            // Initialize state from URL
            const initialState = useMemo(() => getParamsFromURL(), []);
            
            const [location, setLocation] = useState(initialState.location);
            const [propertyType, setPropertyType] = useState(initialState.propertyType);
            const [inputs, setInputs] = useState(initialState.inputs);
            
            const [activeTab, setActiveTab] = useState("property"); 
            const [homeValueDisplay, setHomeValueDisplay] = useState(new Intl.NumberFormat('en-US').format(initialState.inputs.homeValue));
            const [rentDisplay, setRentDisplay] = useState(new Intl.NumberFormat('en-US').format(initialState.inputs.monthlyRent));
            const [maxHomePrice, setMaxHomePrice] = useState(Math.max(5000000, initialState.inputs.homeValue * 1.5));
            const [copied, setCopied] = useState(false);

        
            const [ranges, setRanges] = useState({
                maxHomeValue: DEFAULT_INPUTS.homeValue * 4,
                maxRent: 10000
            });
            // --- Update URL on State Change (Write) ---
            useEffect(() => {
                const params = new URLSearchParams();
                
                // Set Inputs
                Object.keys(inputs).forEach(key => {
                    params.set(key, inputs[key]);
                });

                // Set Metadata
                params.set('location', location);
                params.set('type', propertyType);

                // Update URL without reload
                const newUrl = `${window.location.pathname}?${params.toString()}`;
                window.history.replaceState({}, '', newUrl);
            }, [inputs, location, propertyType]);

            const handleShare = () => {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                });
            };

            // --- Computed Market Ranges ---
            const currentRanges = useMemo(() => {
                const locData = MARKET_DATA[location];
                const propData = locData.propertyTypes[propertyType];

                const toRangeObj = (arr) => ({
                    min: arr[0],
                    q1: arr[1],
                    med: (arr[1] + arr[2]) / 2,
                    q3: arr[2],
                    max: arr[3]
                });

                return {
                    mortgage: toRangeObj(locData.mortgageRate),
                    stock: toRangeObj(locData.investmentReturn),
                    appreciation: toRangeObj(propData.appreciation),
                    fees: toRangeObj(propData.feesRate)
                };
            }, [location, propertyType]);

            // --- Market Outlook Score ---
            const marketOutlookScore = useMemo(() => {
                const getScore = (val, min, max, isInverse) => {
                    let pct = (val - min) / (max - min);
                    if (isInverse) pct = 1 - pct;
                    return Math.max(0, Math.min(100, pct * 100));
                };

                const r = currentRanges;
                
                const rateScore = getScore(inputs.mortgageRate, r.mortgage.min, r.mortgage.max, true);
                const apprScore = getScore(inputs.appreciation, r.appreciation.min, r.appreciation.max, false);
                const feesScore = getScore(inputs.feesRate, r.fees.min, r.fees.max, true);

                return (rateScore + apprScore + feesScore) / 3;
            }, [inputs.mortgageRate, inputs.appreciation, inputs.feesRate, currentRanges]);

            const getOutlookLabel = (score) => {
                if (score < 25) return "Pessimistic";
                if (score < 45) return "Conservative";
                if (score < 65) return "Neutral";
                if (score < 85) return "Optimistic";
                return "Aggressive";
            };

            // --- Calculations ---
            const calculateTotals = (vals) => {
                const H = vals.homeValue;
                const D = H * (vals.downPaymentPercent / 100);
                const Loan = H - D;
                
                const feesCost = H * (vals.feesRate / 100);
                const interestCost = Loan * (vals.mortgageRate / 100);
                const totalAppreciation = H * (vals.appreciation / 100);
                const investmentReturn = D * (vals.stockReturn / 100);

                const grossBuyCost = feesCost + interestCost;
                const netBuyCost = grossBuyCost - totalAppreciation;
                
                const annualRent = vals.monthlyRent * 12;
                const netRentCost = annualRent - investmentReturn;
                
                return {
                    netBuyCost, netRentCost, 
                    grossBuyCost, totalAppreciation, investmentReturn, 
                    feesCost, interestCost, annualRent, loanAmount: Loan, downPayment: D
                };
            };

            const totals = useMemo(() => calculateTotals(inputs), [inputs]);

            // --- Range Estimates ---
            const rangeEstimates = useMemo(() => {
                const r = currentRanges;

                const optimisticCalc = calculateTotals({
                    ...inputs,
                    mortgageRate: r.mortgage.q1,
                    appreciation: r.appreciation.q3,
                    feesRate: r.fees.q1,
                    stockReturn: r.stock.q1
                });
                const optimisticDiff = optimisticCalc.netRentCost - optimisticCalc.netBuyCost;

                const conservativeCalc = calculateTotals({
                    ...inputs,
                    mortgageRate: r.mortgage.q3,
                    appreciation: r.appreciation.q1,
                    feesRate: r.fees.q3,
                    stockReturn: r.stock.q3
                });
                const conservativeDiff = conservativeCalc.netRentCost - conservativeCalc.netBuyCost;

                return { conservative: conservativeDiff, optimistic: optimisticDiff };
            }, [inputs.homeValue, inputs.downPaymentPercent, inputs.monthlyRent, currentRanges]);


            // --- Handlers ---
            const handleInputChange = (e) => {
                // 1. Destructure 'type' along with name and value
                const { name, value, type } = e.target;
                const numValue = parseFloat(value) || 0;

                // 2. Always update the input value (Math state)
                setInputs(prev => ({ ...prev, [name]: numValue }));

                // 3. Dynamic Max Logic: ONLY run this if the user is TYPING.
                //    If we run this while sliding (type === 'range'), the max expands 
                //    as you drag, keeping the slider stuck at 50%.
                if (type === 'text') {
                    if (name === 'homeValue') {
                        // Ensure max is at least 2M, or 2x the typed value
                        setRanges(r => ({ ...r, maxHomeValue: Math.max(DEFAULT_INPUTS.homeValue*4, numValue * 2) }));
                    }
                    if (name === 'monthlyRent') {
                        // Ensure max is at least 10k (4xdefault), or 2x the typed value
                        setRanges(r => ({ ...r, maxRent: Math.max(DEFAULT_INPUTS.monthlyRent*4, numValue * 2) }));
                    }
                }
            };

            // --- Custom Key Handler ---
            const handleSelectKeyDown = (e, options, currentValue, setValue) => {
                if (['ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                    const currentIndex = options.indexOf(currentValue);
                    let newIndex = currentIndex;

                    if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                        newIndex = currentIndex > 0 ? currentIndex - 1 : options.length - 1;
                    } else {
                        newIndex = currentIndex < options.length - 1 ? currentIndex + 1 : 0;
                    }
                    setValue(options[newIndex]);
                }
            };
            const handleReset = () => {
                // 1. Reset Math Inputs
                setInputs(DEFAULT_INPUTS);
                
                // 2. Reset Text Displays (The commas)
                setHomeValueDisplay(new Intl.NumberFormat('en-US').format(DEFAULT_INPUTS.homeValue));
                setRentDisplay(new Intl.NumberFormat('en-US').format(DEFAULT_INPUTS.monthlyRent));
                
                // 3. Reset Dropdowns
                setLocation("Global");
                setPropertyType("house");
                
                // 4. Reset Dynamic Slider Maxes
                setRanges({ maxHomeValue: DEFAULT_INPUTS.homeValue*4, maxRent: DEFAULT_INPUTS.monthlyRent*4 });
            };

            // --- Visualization Logic ---

            const maxDollarHeight = Math.max(
                totals.feesCost, 
                totals.interestCost, 
                totals.annualRent, 
                Math.abs(totals.totalAppreciation) * 0.6, 
                Math.abs(totals.investmentReturn) * 0.6,
                12000
            );
            const scaleFactor = 150 / maxDollarHeight; 

            const getBalloonRadius = (val) => {
                if (val <= 0) return 0;
                const area = val * scaleFactor * 60; 
                return Math.sqrt(area / Math.PI);
            };

            const greenRadius = getBalloonRadius(totals.totalAppreciation);
            const yellowRadius = getBalloonRadius(totals.investmentReturn);

            // Physics
            const diff = totals.netBuyCost - totals.netRentCost; 
            const maxTilt = 12; 
            const sensitivity = Math.max(inputs.homeValue * 0.05, 5000); 
            let tiltAngle = -(diff / sensitivity) * maxTilt;
            if (tiltAngle > maxTilt) tiltAngle = maxTilt;
            if (tiltAngle < -maxTilt) tiltAngle = -maxTilt;

            // Dimensions
            const pivotX = 400;
            const pivotY = 340; 
            const armLength = 200; 
            const legHeight = 50;  
            
            // Plate Dimensions - WIDER
            const leftPlateWidth = 335; 
            const rightPlateWidth = 200; 
            const plateHeight = 30; 

            // Formatters
            const formatMoney = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
            const formatK = (val) => '$' + (val / 1000).toFixed(0) + 'k';
            const formatNumberWithCommas = (val) => new Intl.NumberFormat('en-US').format(val);
            
            const formatRangeVal = (val) => {
                const absVal = formatMoney(Math.abs(val));
                return val >= 0 ? `+${absVal}` : `-${absVal}`;
            };
            
            const formatKSimple = (val) => '$' + Math.round(val / 1000) + 'k';

            const netDiff = totals.netRentCost - totals.netBuyCost; 
            const betterOption = netDiff > 0 ? "Buying" : "Renting";

            // --- RENDER HELPERS FOR INPUTS ---
            const PropertyInputs = (
                <div className="space-y-4 animate-fade-in">
                    
                    {/* --- Home Price Section --- */}
                    <div>
                        <label className="block text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1">Home Price</label>
                        
                        {/* Text Input (Uses CurrencyInput to fix cursor jumping) */}
                        <div className="relative">
                            <span className="absolute left-3 top-2 text-slate-500 font-mono text-sm">$</span>
                            <CurrencyInput 
                                name="homeValue"
                                value={inputs.homeValue} 
                                onChange={handleInputChange} 
                                className="w-full pl-6 p-2 bg-slate-50 border border-slate-300 rounded text-sm font-mono text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none" 
                            />
                        </div>

                        {/* Slider Input */}
                        <div className="relative h-6 flex items-center mt-2">
                            <div className="absolute w-full h-2 bg-slate-200 rounded-full"></div>
                            {/* Dynamic Progress Bar based on ranges.maxHomeValue */}
                            <div className="absolute h-4 w-4 bg-blue-600 rounded-full shadow pointer-events-none z-10 transform -translate-x-1/2" style={{ left: `${Math.min(100, (inputs.homeValue / ranges.maxHomeValue) * 100)}%` }}></div>
                            <input 
                                type="range" 
                                name="homeValue" 
                                min="100000" 
                                max={ranges.maxHomeValue} 
                                step="5000" 
                                value={inputs.homeValue} 
                                onChange={handleInputChange} 
                                className="absolute w-full h-full opacity-0 z-20 range-input" 
                            />
                        </div>
                    </div>
                    
                    {/* --- Rent Section --- */}
                    <div>
                        <label className="block text-[10px] font-bold text-slate-500 uppercase tracking-wide mb-1">Monthly Rent</label>
                        
                        <div className="flex items-center gap-3 mb-2">
                            {/* Text Input */}
                            <div className="relative flex-grow">
                                <span className="absolute left-3 top-2 text-slate-500 font-mono text-sm">$</span>
                                <CurrencyInput 
                                    name="monthlyRent" 
                                    value={inputs.monthlyRent} 
                                    onChange={handleInputChange} 
                                    className="w-full pl-6 p-2 bg-slate-50 border border-slate-300 rounded text-sm font-mono text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none" 
                                />
                            </div>
                            {/* Weekly/Yearly Summary */}
                            <div className="flex flex-col text-right text-[10px] font-mono text-slate-500 leading-tight min-w-[80px]">
                                <span>${formatNumberWithCommas(Math.round(inputs.monthlyRent * 12 / 52))}/wk</span>
                                <span>${formatNumberWithCommas(inputs.monthlyRent * 12)}/yr</span>
                            </div>
                        </div>

                        {/* Slider Input */}
                        <div className="relative h-6 flex items-center">
                            <div className="absolute w-full h-2 bg-slate-200 rounded-full"></div>
                            {/* Dynamic Progress Bar based on ranges.maxRent */}
                            <div className="absolute h-4 w-4 bg-slate-600 rounded-full shadow pointer-events-none z-10 transform -translate-x-1/2" style={{ left: `${Math.min(100, (inputs.monthlyRent / ranges.maxRent) * 100)}%` }}></div>
                            <input 
                                type="range" 
                                name="monthlyRent" 
                                min="0" 
                                max={ranges.maxRent} 
                                step="50" 
                                value={inputs.monthlyRent} 
                                onChange={handleInputChange} 
                                className="absolute w-full h-full opacity-0 z-20 range-input" 
                            />
                        </div>
                    </div>
                </div>
            );
            const RatesInputs = (
                <div className="space-y-4 animate-fade-in">
                    <BoxPlotSlider label="Mortgage Rate (Interest)" name="mortgageRate" value={inputs.mortgageRate} min={0} max={14} step={0.1} rangeData={currentRanges.mortgage} onChange={(e) => setInputs(p => ({...p, mortgageRate: parseFloat(e.target.value)}))} leftEmoji="ðŸ“‰" rightEmoji="ðŸ“ˆ" accentColor="bg-orange-500" thumbColor="bg-orange-500" labelColor="text-orange-600" dollarImpact={Math.round((totals.loanAmount * (inputs.mortgageRate/100)) / 12)} ticks={[2, 5, 8, 12]} inverse={true} />
                    <BoxPlotSlider label="Appreciation (Growth on Home Value)" name="appreciation" value={inputs.appreciation} min={-5} max={15} step={0.1} rangeData={currentRanges.appreciation} onChange={(e) => setInputs(p => ({...p, appreciation: parseFloat(e.target.value)}))} leftEmoji="ðŸšï¸" rightEmoji="ðŸš€" accentColor="bg-emerald-500" thumbColor="bg-emerald-500" labelColor="text-emerald-600" dollarImpact={Math.round((inputs.homeValue * (inputs.appreciation/100)) / 12)} ticks={[-2, 3, 8, 12]} inverse={false} />
                    <BoxPlotSlider label="Expenses (Tax, Maintinance, Insurance)" name="feesRate" value={inputs.feesRate} min={0} max={5} step={0.1} rangeData={currentRanges.fees} onChange={(e) => setInputs(p => ({...p, feesRate: parseFloat(e.target.value)}))} leftEmoji="â›º" rightEmoji="ðŸ°" accentColor="bg-red-500" thumbColor="bg-red-500" labelColor="text-red-600" dollarImpact={Math.round((inputs.homeValue * (inputs.feesRate/100)) / 12)} ticks={[0, 1.5, 3, 4.5]} inverse={true} />
                    <BoxPlotSlider label="Investment Return (Post-tax)" name="stockReturn" value={inputs.stockReturn} min={-1} max={20} step={0.1} rangeData={currentRanges.stock} onChange={(e) => setInputs(p => ({...p, stockReturn: parseFloat(e.target.value)}))} leftEmoji="ðŸ»" rightEmoji="ðŸ‚" accentColor="bg-yellow-500" thumbColor="bg-yellow-500" labelColor="text-yellow-600" dollarImpact={Math.round((totals.downPayment * (inputs.stockReturn/100)) / 12)} ticks={[0, 7, 14]} inverse={false} />
                    
                    <div className="pt-4 mt-2 border-t border-slate-100">
                        <label className="flex justify-between text-[10px] font-bold text-blue-800 uppercase tracking-wide mb-1">
                            <span>Down Payment ({inputs.downPaymentPercent}%)</span>
                            <span className="font-mono text-xs">{formatMoney(totals.downPayment)}</span>
                        </label>
                        <div className="relative h-3 flex items-center">
                            <div className="absolute w-full h-2 bg-blue-200 rounded-full"></div>
                            <div className="absolute h-4 w-4 bg-blue-600 rounded-full shadow pointer-events-none z-10 transform -translate-x-1/2" style={{ left: `${inputs.downPaymentPercent}%` }}></div>
                            {/* UPDATED: Added range-input class */}
                            <input type="range" min="0" max="100" step="1" name="downPaymentPercent" value={inputs.downPaymentPercent} onChange={(e) => setInputs(p => ({...p, downPaymentPercent: parseFloat(e.target.value)}))} className="absolute w-full h-full opacity-0 z-20 range-input"/>
                        </div>
                    </div>

                    <div className="pt-4 border-t border-slate-100 flex gap-2">
                        <div className="w-1/3 flex flex-col justify-end">
                            <label className="block text-[9px] font-bold text-slate-400 uppercase tracking-wide mb-1">Location</label>
                            <select value={location} onChange={(e) => setLocation(e.target.value)} onKeyDown={(e) => handleSelectKeyDown(e, Object.keys(MARKET_DATA), location, setLocation)} className="w-full p-1.5 bg-slate-50 border border-slate-300 rounded text-[10px] font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer appearance-none">
                                {Object.keys(MARKET_DATA).map(loc => <option key={loc} value={loc}>{loc}</option>)}
                            </select>
                        </div>
                        <div className="w-1/3 flex flex-col justify-end">
                            <label className="block text-[9px] font-bold text-slate-400 uppercase tracking-wide mb-1">Type</label>
                            <select value={propertyType} onChange={(e) => setPropertyType(e.target.value)} onKeyDown={(e) => handleSelectKeyDown(e, ['house', 'apartment'], propertyType, setPropertyType)} className="w-full p-1.5 bg-slate-50 border border-slate-300 rounded text-[10px] font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer appearance-none">
                                <option value="house">House</option>
                                <option value="apartment">Apartment</option>
                            </select>
                        </div>
                        <div className="w-1/3 flex flex-col items-center">
                            <div className="relative w-20 h-10 overflow-hidden">
                                <svg viewBox="0 0 200 110" className="w-full h-full">
                                    <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="url(#gaugeGradient)" strokeWidth="30" strokeLinecap="round"/>
                                    <g transform="translate(100, 100)">
                                        <g transform={`rotate(${(marketOutlookScore / 100) * 180 - 90})`} className="transition-transform duration-500 ease-out">
                                            <g className={marketOutlookScore > 80 ? 'needle-shake' : ''}>
                                                <polygon points="-4,-10 0,-85 4,-10" fill="#1e293b" />
                                                <circle cx="0" cy="0" r="6" fill="#1e293b" />
                                            </g>
                                        </g>
                                    </g>
                                </svg>
                            </div>
                            <div className={`text-[9px] font-bold uppercase ${marketOutlookScore > 75 ? 'text-emerald-600' : marketOutlookScore < 40 ? 'text-red-600' : 'text-slate-600'}`}>
                                {getOutlookLabel(marketOutlookScore)}
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col items-center w-full min-h-screen bg-slate-50 text-slate-800 font-sans p-2 md:p-4 overflow-hidden">
                
                {/* Global SVG Definitions to fix ID Conflict */}
                <svg width="0" height="0" style={{position: 'absolute'}}>
                    <defs>
                        <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stopColor="#ef4444" />
                            <stop offset="50%" stopColor="#eab308" />
                            <stop offset="100%" stopColor="#22c55e" />
                        </linearGradient>
                    </defs>
                </svg>

                <header className="w-full max-w-6xl mb-4 relative flex flex-col items-center gap-2">
                    <div className="flex items-center gap-3">
                        <h1 className="text-2xl md:text-3xl font-bold text-slate-900 text-center">The Mortgage Equation</h1>
                        <button onClick={handleShare} className="relative group p-2 rounded-full hover:bg-slate-200 transition-colors" title="Share current settings">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-slate-500"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                            {/* Copied Tooltip */}
                            <div className={`absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-[10px] font-bold px-2 py-1 rounded transition-opacity duration-300 pointer-events-none ${copied ? 'opacity-100' : 'opacity-0'}`}>
                                Copied Prefilled URL!
                            </div>
                        </button>
                    </div>
                </header>

                <div className="w-full max-w-7xl flex-grow grid grid-cols-1 lg:grid-cols-[400px_1fr] gap-6">
                    
                    <div className="order-2 lg:order-1 lg:col-start-1 flex flex-col h-full">
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full">
                            <div className="flex border-b border-slate-100 lg:hidden">
                                <button onClick={() => setActiveTab('property')} className={`flex-1 py-3 text-xs font-bold uppercase tracking-wide transition-colors ${activeTab === 'property' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50' : 'text-slate-400 hover:text-slate-600'}`}>Property</button>
                                <button onClick={() => setActiveTab('rates')} className={`flex-1 py-3 text-xs font-bold uppercase tracking-wide transition-colors ${activeTab === 'rates' ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50' : 'text-slate-400 hover:text-slate-600'}`}>Rates</button>
                            </div>

                            <div className="p-4 flex-grow overflow-y-auto">
                                <div className="lg:hidden">
                                    {activeTab === 'property' && PropertyInputs}
                                    {activeTab === 'rates' && RatesInputs}
                                </div>
                                <div className="hidden lg:flex flex-col gap-6">
                                    
                                    {/* Property Details Section with Reset Button */}
                                    <div>
                                        <div className="flex justify-between items-end border-b border-slate-100 pb-2 mb-4">
                                            <h2 className="text-sm font-bold text-slate-800 uppercase tracking-wider">Property Details</h2>
                                            <button 
                                                onClick={handleReset} 
                                                className="text-[10px] font-bold text-slate-400 hover:text-blue-600 transition-colors flex items-center gap-1"
                                                title="Reset to defaults"
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                                RESET
                                            </button>
                                        </div>
                                        {PropertyInputs}
                                    </div>

                                    {/* Market Factors Section */}
                                    <div>
                                        <h2 className="text-sm font-bold text-slate-800 uppercase tracking-wider mb-4 border-b border-slate-100 pb-2">Market Factors</h2>
                                        {RatesInputs}
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="order-1 lg:order-2 flex flex-col gap-2">
                        
                        {/* FULL EQUATION BREAKDOWN (UPDATED UI) */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            
                            {/* --- Buying Card --- */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-col h-full">
                                {/* Card Header (Matches Renting Card Style) */}
                                <div className="text-[10px] font-bold text-slate-500 uppercase tracking-wider border-b border-slate-100 pb-2 mb-3">
                                    Cost of Buying
                                </div>

                                <div className="flex-grow flex flex-col justify-between">
                                    {/* The Grid: 3 Columns [Label - Equation - Value] */}
                                    <div className="grid grid-cols-[90px_1fr_80px] md:grid-cols-[100px_1fr_90px] gap-y-3 text-[11px] sm:text-xs font-mono items-center">
                                        
                                        {/* Row 1: Interest */}
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full bg-orange-500 shrink-0"></div>
                                            <span className="font-bold text-slate-700">Interest</span>
                                        </div>
                                        <div className="text-center text-slate-400">
                                            ({formatKSimple(totals.loanAmount)}Ã—{inputs.mortgageRate}%)
                                        </div>
                                        <div className="text-right font-medium text-slate-700">
                                            {formatMoney(totals.interestCost)}
                                        </div>

                                        {/* Row 2: Expenses (Formerly Fees) */}
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full bg-red-500 shrink-0"></div>
                                            <span className="font-bold text-slate-700">Expenses</span>
                                        </div>
                                        <div className="text-center text-slate-400">
                                            ({formatKSimple(inputs.homeValue)}Ã—{inputs.feesRate}%)
                                        </div>
                                        <div className="text-right font-medium text-slate-700">
                                            + {formatMoney(totals.feesCost)}
                                        </div>

                                        {/* Row 3: Appreciation */}
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full bg-emerald-500 shrink-0"></div>
                                            <span className="font-bold text-slate-700">Appreciation</span>
                                        </div>
                                        <div className="text-center text-slate-400">
                                            ({formatKSimple(inputs.homeValue)}Ã—{inputs.appreciation}%)
                                        </div>
                                        <div className="text-right font-medium text-emerald-600">
                                            - {formatMoney(Math.abs(totals.totalAppreciation))}
                                        </div>
                                    </div>

                                    {/* Net Total Section */}
                                    <div>
                                        <div className="border-t border-slate-100 my-3"></div>
                                        <div className="flex justify-between items-center">
                                            <span className="font-bold text-slate-900 text-xs sm:text-sm">Net Annual Cost</span>
                                            <span className="font-bold text-slate-900 text-sm sm:text-base">= {formatMoney(totals.netBuyCost)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* --- Renting Card --- */}
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-col h-full">
                                <div className="text-[10px] font-bold text-slate-500 uppercase tracking-wider border-b border-slate-100 pb-2 mb-3">
                                    Cost of Renting
                                </div>

                                <div className="flex-grow flex flex-col justify-between">
                                    {/* The Grid: Same columns as Buying for alignment */}
                                    <div className="grid grid-cols-[90px_1fr_80px] md:grid-cols-[100px_1fr_90px] gap-y-3 text-[11px] sm:text-xs font-mono items-center">
                                        
                                        {/* Row 1: Rent */}
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full bg-slate-500 shrink-0"></div>
                                            <span className="font-bold text-slate-700">Rent</span>
                                        </div>
                                        <div className="text-center text-slate-400">
                                            ({formatMoney(inputs.monthlyRent)}Ã—12)
                                        </div>
                                        <div className="text-right font-medium text-slate-700">
                                            {formatMoney(totals.annualRent)}
                                        </div>

                                        {/* Row 2: Investment Return */}
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 rounded-full bg-yellow-500 shrink-0"></div>
                                            <span className="font-bold text-slate-700">Investment Return</span>
                                        </div>
                                        <div className="text-center text-slate-400">
                                            ({formatKSimple(totals.downPayment)}Ã—{inputs.stockReturn}%)
                                        </div>
                                        <div className="text-right font-medium text-yellow-600">
                                            - {formatMoney(Math.abs(totals.investmentReturn))}
                                        </div>
                                    </div>

                                    {/* Net Total Section */}
                                    <div>
                                        <div className="border-t border-slate-100 my-3"></div>
                                        <div className="flex justify-between items-center">
                                            <span className="font-bold text-slate-900 text-xs sm:text-sm">Net Annual Cost</span>
                                            <span className="font-bold text-slate-900 text-sm sm:text-base">= {formatMoney(totals.netRentCost)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 relative overflow-hidden w-full aspect-[2/1] flex flex-col">
                            <div className={`absolute top-4 left-0 right-0 mx-auto w-fit px-4 py-1.5 rounded-full font-bold text-xs md:text-sm shadow-md z-10 border transition-colors duration-300
                                ${betterOption === 'Buying' ? 'bg-blue-600 text-white border-blue-700' : 'bg-slate-800 text-white border-slate-900'}`}>
                                {betterOption === 'Buying' ? "Consider a Mortgage" : "Keep Renting & Investing"}
                            </div>

                            <svg viewBox="0 0 800 400" className="w-full h-full flex-grow touch-none select-none">
                                <line x1="100" y1="390" x2="700" y2="390" stroke="#e2e8f0" strokeWidth="4" strokeLinecap="round" />
                                <path d={`M${pivotX} ${pivotY} L${pivotX - 30} ${pivotY + 40} L${pivotX + 30} ${pivotY + 40} Z`} fill="#64748b" />
                                <circle cx={pivotX} cy={pivotY} r="6" fill="#475569" />

                                <g transform={`rotate(${tiltAngle}, ${pivotX}, ${pivotY})`}>
                                    <rect x={pivotX - armLength - 10} y={pivotY - 10} width={(armLength * 2) + 20} height={20} rx="4" fill="#334155" />
                                    <circle cx={pivotX - armLength} cy={pivotY} r="4" fill="#94a3b8" />
                                    <circle cx={pivotX + armLength} cy={pivotY} r="4" fill="#94a3b8" />
                                    
                                    {/* SUMS ON BEAM - Rotates with beam */}
                                    <text x={pivotX - armLength/2} y={pivotY } textAnchor="middle" dominantBaseline="central" fill="white" fontSize="14" fontWeight="bold">{formatMoney(totals.netBuyCost)}/yr</text>
                                    <text x={pivotX + armLength/2} y={pivotY} textAnchor="middle" dominantBaseline="central" fill="white" fontSize="14" fontWeight="bold">{formatMoney(totals.netRentCost)}/yr</text>
                                </g>

                                {(() => {
                                    const rads = (tiltAngle * Math.PI) / 180;
                                    const leftTipX = pivotX + (armLength * Math.cos(rads + Math.PI));
                                    const leftTipY = pivotY + (armLength * Math.sin(rads + Math.PI));
                                    const rightTipX = pivotX + (armLength * Math.cos(rads));
                                    const rightTipY = pivotY + (armLength * Math.sin(rads));

                                    return (
                                        <>
                                            <text x={pivotX} y={pivotY - legHeight - 20} textAnchor="middle" dominantBaseline="central" fill="#94a3b8" fontSize="50" fontWeight="900">&lt;</text>
                                            
                                            {/* LEFT: Interest + Fees - Appreciation */}
                                            <g>
                                                <rect x={leftTipX - 4} y={leftTipY - legHeight} width={8} height={legHeight} fill="#475569" />
                                                <g transform={`translate(${leftTipX}, ${leftTipY - legHeight})`}>
                                                    {/* Width 320. Items at -105, 0, 105. Signs at -52.5, 52.5. */}
                                                    <rect x={-leftPlateWidth/2} y="0" width={leftPlateWidth} height={plateHeight} rx="3" fill="white" stroke="black" strokeWidth="2" />
                                                    <PlatformItem x={-105} y={0} label="Interest" labelColor="#f97316" value={totals.interestCost} color="#f97316" scaleFactor={scaleFactor} isBalloon={false} />
                                                    <text x={-58} y={23} textAnchor="middle" fill="black" fontSize="25" fontWeight="900">+</text>
                                                    <PlatformItem x={-7} y={0} label="Expenses" labelColor="#ef4444" value={totals.feesCost} color="#ef4444" scaleFactor={scaleFactor} isBalloon={false} />
                                                    
                                                    <text x={totals.totalAppreciation >= 0 ? 43 : 52} y={25} textAnchor="middle" fill= "black" fontSize="25" fontWeight="900">{totals.totalAppreciation >= 0 ? '-' : '+'}</text>
                                                    
                                                    <PlatformItem x={105} y={0} label={totals.totalAppreciation >= 0 ? "Appreciation" : "Loss"} labelColor={totals.totalAppreciation >= 0 ? "#10b981" : "#059669"} value={totals.totalAppreciation} color={totals.totalAppreciation >= 0 ? "#10b981" : "#d1fae5"} scaleFactor={scaleFactor} balloonRadius={greenRadius} isBalloon={true} emoji="ðŸ " />
                                                </g>
                                            </g>
                                            
                                            {/* RIGHT: Rent - Invest */}
                                            <g>
                                                <rect x={rightTipX - 4} y={rightTipY - legHeight} width={8} height={legHeight} fill="#475569" />
                                                <g transform={`translate(${rightTipX}, ${rightTipY - legHeight})`}>
                                                    <rect x={-rightPlateWidth/2} y="0" width={rightPlateWidth} height={plateHeight} rx="3" fill="white" stroke="black" strokeWidth="2" />
                                                    <PlatformItem x={-65} y={0} label="Rent" labelColor="#64748b" value={totals.annualRent} color="#64748b" scaleFactor={scaleFactor} isBalloon={false} />
                                                    <text x={0} y={23} textAnchor="middle" fill="black" fontSize="32" fontWeight="900">{totals.investmentReturn >= 0 ? '-' : '+'}</text>
                                                    <PlatformItem x={65} y={0} label={totals.investmentReturn >= 0 ? "Invest" : "Loss"} labelColor={totals.investmentReturn >= 0 ? "#eab308" : "#854d0e"} value={totals.investmentReturn} color={totals.investmentReturn >= 0 ? "#eab308" : "#fef08a"} scaleFactor={scaleFactor} balloonRadius={yellowRadius} isBalloon={true} emoji="ðŸ“ˆ" />
                                                </g>
                                            </g>
                                        </>
                                    );
                                })()}
                            </svg>
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 px-4 py-3 flex items-center justify-between gap-2 text-xs overflow-x-auto no-scrollbar whitespace-nowrap">
                            <div className="flex items-center gap-2 pr-4 border-r border-slate-100 shrink-0">
                                <span className="font-bold text-slate-500 uppercase text-[10px]">Net Difference with a Mortgage:</span>
                                <span className={`font-mono font-bold text-sm ${netDiff > 0 ? 'text-blue-600' : 'text-slate-700'}`}>
                                    {netDiff > 0 ? '+' :''}{formatMoney(netDiff)}
                                </span>
                            </div>
                            <div className="flex items-center gap-3 text-slate-500 font-mono shrink-0">
                                <span className="text-[10px] font-bold text-slate-400 uppercase">Range:</span>
                                <span>({formatRangeVal(rangeEstimates.conservative)})</span>
                                <span className="text-slate-300">â€“</span>
                                <span>({formatRangeVal(rangeEstimates.optimistic)})</span>
                            </div>
                        </div>

                        <div className="hidden lg:block mt-2 text-center p-2 text-[10px] text-slate-400 leading-relaxed">
                            <p className="italic">DISCLAIMER: Educational use only. Markets change dramatically.</p>
                        </div>

                    </div>

                    <div className="order-3 lg:hidden text-center p-4 text-[10px] text-slate-400 leading-relaxed">
                        <p className="italic">DISCLAIMER: Educational use only. Markets change dramatically.</p>
                    </div>

                </div>
            </div>
            );
        };

        const PlatformItem = ({ x, y, label, labelColor, value, color, scaleFactor, balloonRadius, isBalloon, emoji }) => {
            const formatMoney = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
            const height = Math.abs(value) * scaleFactor;
            const isLoss = value < 0 && isBalloon; 
            const showValue = height > 20 || (isBalloon && !isLoss && balloonRadius > 20);

            return (
                <g transform={`translate(${x}, ${y})`}>
                    <text y="22" textAnchor="middle" fill={labelColor} fontSize="18" fontWeight="800">{label}</text>
                    {isBalloon && !isLoss ? (
                        <g>
                            <line x1="0" y1="0" x2="0" y2="-50" stroke="#cbd5e1" strokeWidth="2" />
                            <g transform={`translate(0, -50)`}>
                                <circle cx="0" cy={-balloonRadius - 4} r={balloonRadius} fill={color} opacity="0.2" />
                                {emoji && <text x="0" y={-balloonRadius} textAnchor="middle" dominantBaseline="central" fontSize={Math.max(16, balloonRadius * 1.0)}>{emoji}</text>}
                                <path d={`M 0 0 L -3 -6 L 3 -6 Z`} fill={color} />
                                {showValue && <text x="0" y={-balloonRadius + (balloonRadius) + 14} textAnchor="middle" fill="#334155" fontSize="13" fontWeight="bold">{formatMoney(value)}</text>}
                            </g>
                        </g>
                    ) : (
                        <g>
                            <rect x="-25" y={-height} width="50" height={height} fill={isLoss ? '#d1fae5' : color} stroke={isLoss ? '#059669' : 'white'} strokeWidth="1" />
                            {showValue && <text x="0" y={-height/2 + 4} textAnchor="middle" fill={isLoss ? "#334155" : "white"} fontSize="13" fontWeight="bold">{formatMoney(Math.abs(value))}</text>}
                        </g>
                    )}
                </g>
            );
        };

        const BoxPlotSlider = ({ label, name, value, min, max, step, onChange, leftEmoji, rightEmoji, accentColor, thumbColor, labelColor, dollarImpact, rangeData, ticks, inverse }) => {
            const getPercent = (v) => ((v - min) / (max - min)) * 100;
            const boxStart = getPercent(rangeData.q1);
            const boxWidth = getPercent(rangeData.q3) - boxStart;
            const medianPos = getPercent(rangeData.med);
            const minPos = getPercent(rangeData.min);
            const maxPos = getPercent(rangeData.max);
            const currentPos = getPercent(value);
            
            let thumbContent = null; 
            let thumbClass = thumbColor; 
            const isBelowWhisker = value < (rangeData.min - (rangeData.max - rangeData.min) * 0.1);
            const isAboveWhisker = value > (rangeData.max + (rangeData.max - rangeData.min) * 0.1);

            if (inverse) {
                if (isBelowWhisker) thumbContent = 'ðŸ¤ª';
                else if (isAboveWhisker) thumbContent = 'ðŸ§';
            } else {
                if (isBelowWhisker) thumbContent = 'ðŸ§';
                else if (isAboveWhisker) thumbContent = 'ðŸ¤ª';
            }

            return (
                <div>
                    <div className="flex justify-between items-end mb-1">
                        <label className={`text-[11px] font-bold uppercase tracking-wide ${labelColor}`}>{label}</label>
                        <div className="text-right">
                            <span className="font-mono text-xs font-bold text-slate-900">{value}%</span>
                            {dollarImpact !== undefined && (
                                <span className={`ml-2 font-mono text-[10px] ${dollarImpact < 0 ? 'text-red-500' : 'text-slate-400'}`}>
                                    {dollarImpact < 0 ? '-' : '+'}{new Intl.NumberFormat('en-US').format(Math.abs(dollarImpact))}/mo
                                </span>
                            )}
                        </div>
                    </div>
                    <div className="flex items-center gap-2 relative">
                        <span className="text-sm grayscale opacity-70">{leftEmoji}</span>
                        <div className="relative flex-grow h-8 flex flex-col justify-center">
                            <div className="absolute top-2 left-0 right-0 h-2 pointer-events-none">
                                <div className="absolute top-1/2 left-0 w-full h-1 bg-slate-200 rounded-full transform -translate-y-1/2"></div>
                                <div className="absolute top-1/2 left-0 h-px bg-slate-400 z-0" style={{ left: `${minPos}%`, right: `${100 - maxPos}%` }}></div>
                                <div className="absolute top-1/2 h-2 w-px bg-slate-400 transform -translate-y-1/2 z-0" style={{ left: `${minPos}%` }}></div>
                                <div className="absolute top-1/2 h-2 w-px bg-slate-400 transform -translate-y-1/2 z-0" style={{ left: `${maxPos}%` }}></div>
                                <div className={`absolute top-1/2 h-3 transform -translate-y-1/2 opacity-30 z-0 ${accentColor}`} style={{ left: `${boxStart}%`, width: `${boxWidth}%` }}></div>
                                <div className={`absolute top-1/2 h-3 w-0.5 transform -translate-y-1/2 opacity-50 z-0 ${accentColor}`} style={{ left: `${medianPos}%` }}></div>
                            </div>
                            <div className={`absolute top-1/2 h-5 w-5 rounded-full shadow pointer-events-none z-10 transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center text-sm bg-white border border-slate-200 transition-transform duration-200 ${thumbContent ? 'scale-125' : 'scale-100'}`} style={{ left: `${currentPos}%` }}>
                                {thumbContent ? <span>{thumbContent}</span> : <div className={`w-3 h-3 rounded-full ${thumbClass}`}></div>}
                            </div>
                            {/* UPDATED: Added range-input class */}
                            <input type="range" min={min} max={max} step={step} name={name} value={value} onChange={onChange} className="relative z-20 w-full h-8 opacity-0 cursor-pointer margin-0 padding-0 range-input" />
                            {ticks && (
                                <div className="absolute bottom-0 left-0 w-full h-3 text-[8px] text-slate-400 font-mono pointer-events-none">
                                    {ticks.map(t => (
                                        <div key={t} className="absolute bottom-0 transform -translate-x-1/2 flex flex-col items-center" style={{ left: `${getPercent(t)}%` }}>
                                            <div className="h-1 w-px bg-slate-300 mb-0.5"></div>
                                            <span>{t}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <span className="text-sm grayscale opacity-70">{rightEmoji}</span>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RentVsBuySeesaw />);
    </script>
</body>
</html>
